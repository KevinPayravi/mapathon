<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Mapathon - Mapping upcoming and past hackathons by month</title>
    <!-- Google Maps API -->
  
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
      <link href='http://fonts.googleapis.com/css?family=Pacifico' rel='stylesheet' type='text/css'>
    <link href="./css/style.css" rel="stylesheet">    
    <script>
    /** NOTE THAT VANILLA/PURE JAVASCRIPT IS USED HERE INSTEAD OF JQUERY TO MAKE SURE THE MAP CAN BE USED PRETTY MUCH EVERYWHERE THAT ALLOWS JAVASCRIPT **/
    
    /*** Global variables ***/
    var map; // To reference the map
    var markers = new Array(); // to refer to the array of markers
    var infowindows = new Array(); // to refer to the infowindows attached to the markers
    var openInfoWindows = new Array(); // to refer to the infowindows that are open right now
    var detailsForEachHackathon = new Array(); // to contain the objects needed for each hackathon, remove this and geocoding creates a bug
    var lastHackathonAddress; // just to center the map on something near the group of hackathon markers
    var x = 0; // for geocoding purposes as they need a global variable to refer to the index of the array
    var markerIcon = "https://cloud.githubusercontent.com/assets/9067177/8510467/e281c302-22b3-11e5-8ea4-08b55c12845a.png"; // The standard icon for the marker
    var numOfAlertsAbout2014 = 0; // recording this to not annoy user
   
    /*** Functions ***/
    
                    /******* UI and Animation functions *******/

    /**
     * Pops out opening screen with instructions on how to use it
     * Takes in the div to be used to store openingScreen and the map its for
     **/ 
    function InstructionScreen(openScreenDiv,map) {
      // creates a div HTML element to hold the UI
      var openScreenUI = document.createElement("div");
      openScreenUI.style.marginLeft = "2em";
      openScreenUI.style.backgroundColor = '#8e44ad';
      openScreenUI.style.border = '2px solid #333';
      openScreenUI.style.borderRadius = '5px';
      openScreenUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      openScreenUI.style.marginBottom = '10em';
      openScreenUI.style.textAlign = 'center';
      openScreenUI.style.width = '100%';
      openScreenDiv.appendChild(openScreenUI);

      // creates another div inside to hold text
      var openingScreenText = document.createElement('div');
      openingScreenText.style.color = '#fff';
      openingScreenText.style.fontSize = '14px';
      openingScreenText.style.lineHeight = '20px';
      openingScreenText.style.paddingLeft = '10em';
      openingScreenText.style.paddingRight = '10em';
      openingScreenText.innerHTML = " <b> Instructions : </b> Choose the year and the month and get a display of the hackathons around the world at that time, press <b> next </b> to close the instructions. <br> <br>Also note that I have only displayed at max 20 hackathons as thats the Google Maps API Geocoding Query Limit! ";
      openScreenUI.appendChild(openingScreenText);

    }

    /**
     * Loads the next button
     * If pressed it calls the closeOpeningScreen()
     **/
    function NextButton(openScreenDiv, map) {
      // creates a div HTML element to hold the UI
      var nextButton = document.createElement("div");
      nextButton.style.cursor = 'pointer';
      nextButton.style.backgroundColor = '#8e44ad';
      nextButton.style.border = '2px solid #333';
      nextButton.style.borderRadius = '10px';
      nextButton.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      nextButton.style.marginBottom = '5em';
      nextButton.style.marginRight = '5em';
      nextButton.style.textAlign = 'center';
      openScreenDiv.appendChild(nextButton);

      // creates another div inside to hold text
      var nextButtonText = document.createElement('div');
      nextButtonText.style.color = '#fff';
      nextButtonText.style.fontFamily = 'Roboto,Arial,sans-serif';
      nextButtonText.style.fontSize = '20px';
      nextButtonText.style.lineHeight = '38px';
      nextButtonText.style.paddingLeft = '10em';
      nextButtonText.style.paddingRight = '10em';
      nextButtonText.innerHTML = " <b>NEXT </b> ";
      nextButton.appendChild(nextButtonText);
    }
        
    /**
     * For fading in animation on the buttons
     **/
    function fadeIn(element) {
      var op = 0.1;  // initial opacity
      element.style.display = 'block';
      var timer = setInterval(function () {
        if (op >= 1){
            clearInterval(timer);
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op += op * 0.05;
    }, 10);
  }

    /**
     * For fading out animation on the buttons
     **/
    function fadeOut(element) {
      var op = 1;  // initial opacity
      var timer = setInterval(function () {
          if (op <= 0.1){
              clearInterval(timer);
              element.style.display = 'none';
          }
          element.style.opacity = op;
          element.style.filter = 'alpha(opacity=' + op * 100 + ")";
          op -= op * 0.1;
    }, 50);
  }
                        
                    /****** Data and Map functions ******/

    /**
     * Returns the year chosen by user with the select html element 
     **/
    function getYear() {
        var yearSelect = document.getElementById('yearSelect');
        var chosenYear = yearSelect.options[yearSelect.selectedIndex].value;      
        return chosenYear;
    }
        
    /**
     * Returns the year chosen by user with the select html element 
     **/
    function getMonth() {
        var monthSelect = document.getElementById('monthSelect');
        var chosenMonth = monthSelect.options[monthSelect.selectedIndex].value;      
        return chosenMonth;
    }
        
    /**
     * Take a month in integer format and converts it to string
     **/
    function convertIntToMonth(monthToConvert) {
        var monthAsInt = parseInt(monthToConvert) - 1;
        var month = new Array();
        month[0] = "January";
        month[1] = "February";
        month[2] = "March";
        month[3] = "April";
        month[4] = "May";
        month[5] = "June";
        month[6] = "July";
        month[7] = "August";
        month[8] = "September";
        month[9] = "October";
        month[10] = "November";
        month[11] = "December";
        var convertedMonth = month[monthAsInt];
        return convertedMonth;
    }
        
    /**
     * Gets the year and month chosen and outputs marker on the map
     * Creates an error if there is no year or month
     **/
    function getMarkerFromChosenTime() {
        var url = "";
        var chosenYear = getYear();
        var chosenMonth = getMonth();
        if (chosenYear && chosenMonth) {
             url = createURLWhenTimeIsSpecifiedForHackalistAPI(chosenYear,chosenMonth);
             var JSONAboutHackathon = grabJSONFromHackalist(url);
             convertAddressesToMarker(JSONAboutHackathon, chosenMonth);
        } else {
            alert("Year and Month hasn't been selected properly, try again!");
        }
    }

    /**
     * Creates url depending on which month is pressed
     * Takes in the year and month specified
     * Returns the URL
     **/
    function createURLWhenTimeIsSpecifiedForHackalistAPI(year,month) {
      yearStr = year.toString();
      monthStr = month.toString();
      var URL = "http://www.hackalist.org/api/1.0/" + yearStr + "/" + monthStr + ".json";
      return URL;
    }
    
    /**
     * Gets the JSON data from Hackalist API
     * Returns as JSON
     **/
    function grabJSONFromHackalist(hackalistURL) {
      var JSONrequest = new XMLHttpRequest();
      JSONrequest.open("GET", hackalistURL, false);
      JSONrequest.send();
      JSONresponse = JSONrequest.responseText;
      var JSONToBeReturned = JSON.parse(JSONresponse);
      return JSONToBeReturned;
    }
    
    /**
     * Converts the Addresses into LatLng format with Geocoding
     * Takes JSON data as Input where address information is used
     * Also confirms the month by taking it as integer format and turning into a string of the month name
     * Puts a marker onto the map with the details of the hackathon
     **/
    function convertAddressesToMarker(JSONInput,month) {
      clearAllMarkersAndInfo();
      var givenMonth = convertIntToMonth(month);
      var numOfHackathonsInThatMonth = JSONInput[givenMonth].length;
        for (var i = 0; i < numOfHackathonsInThatMonth; i++) {
          var givenAddress = JSON.stringify(JSONInput[givenMonth][i].city);
          var geocoder = new google.maps.Geocoder();
          // grabs the data from Hackalist API and assigns them to variables
          var cityName = JSONInput[givenMonth][i].city;
          var hackathonName = JSONInput[givenMonth][i].title;
          var hackathonHost = JSONInput[givenMonth][i].host;
          var hackathonUrl = JSONInput[givenMonth][i].url;
          var startDate = JSONInput[givenMonth][i].startDate;
          var endDate = JSONInput[givenMonth][i].endDate;
          // creates an object to store the details of the hackathon as geocoder screws things up
          var hackathonDetails = {
            city: cityName,
            eventName: hackathonName,
            organizers:hackathonHost,
            url:hackathonUrl,
            begin:startDate,
            end:endDate
          };
          detailsForEachHackathon.push(hackathonDetails);
          // geocoder takes in the address and returns latitude and longitude
          geocoder.geocode( { 'address': givenAddress}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              var latLngAddress = results[0].geometry.location;
              // creates a new marker
              var marker = new google.maps.Marker({
                map: map,
                icon: markerIcon,
                position: latLngAddress,
                clickable: true
              });
              // sets the attributes of the marker by taking it from the hackathonDetails Object
              marker.set("city", detailsForEachHackathon[x].city);
              console.info(marker.get("city"));
              marker.set("eventName", detailsForEachHackathon[x].eventName);
              marker.set("host", detailsForEachHackathon[x].organizers);
              marker.set("url", detailsForEachHackathon[x].url);
              marker.set("start", detailsForEachHackathon[x].begin);
              marker.set("end", detailsForEachHackathon[x].end);
              // sets an infowindow for the marker
              setInfoWindow(marker);
              markers.push(marker);
              lastHackathonAddress = latLngAddress;
              x++;
              console.log(x);
            } else if (status == google.maps.GeocoderStatus.ZERO_RESULTS){
            	console.error("There was an error geocoding this address");
              markers.push();
            }
          });
        }
    }
    /**
     * Clear previously selected markers and infowindows if there are any
     **/
    function clearAllMarkersAndInfo() {
    	for (var j = 0; j < markers.length; j++) {
			markers[j].setMap(null);
			if (infowindows[j]) {
				infowindows[j].close();
				infowindows.pop();
			}
		}
  }
    /**
     * Attaches the infowindow to the marker
     * Takes the marker
     **/ 
    function setInfoWindow(marker) {
        google.maps.event.addListener(marker, 'click', function(event) {
            var infoWindow = new google.maps.InfoWindow({disableAutoPan: true});
            var city = marker.get("city");
            var eventName = marker.get("eventName");
            var host = marker.get("host");
            var url = marker.get("url");
            var startDate = marker.get("start");
            var endDate = marker.get("end");
            var contentString = "<div class='infowindow'> <b> Name: </b> " + eventName + "<br> <b> Host </b>: " + host + "<br> <b>Address: </b>" + city + "<br> <b> Website: </b><a href=" + url + ">" + url +"</a>" + "<br> <b> Starting date : </b>" + startDate + "<br> <b> Ending date : </b>" + endDate + "</div>";
            infoWindow.setContent(contentString);
            infowindows.push(infoWindow);
            openInfoWindows.push(infoWindow);
            infoWindow.open(map, this);
            // closes previous infowindow if there is another
            if (openInfoWindows.length > 1) {
              openInfoWindows[0].close();
              openInfoWindows[0] = openInfoWindows[1];
              openInfoWindows.pop();
            }
            // if click elsewhere on the map, infowindow closes
            google.maps.event.addListener(map, 'click', function() {
              infoWindow.close();
            });
        });
    } 


    /**
     * Creates the map; see this as the main function
     **/
    function initialize() {
     // below is configurable content for the map
      var mapOptions = {
        zoom: 4,
        minZoom: 3,
        center: {lat: -34.397, lng: 150.644},
        styles: [{"featureType":"all","elementType":"all","stylers":[{"invert_lightness":true},{"saturation":10},{"lightness":30},{"gamma":0.5},{"hue":"#435158"}]}],
        disableDefaultUI: true
      }; 
      map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
      
      /** Sets up the UI and instructions **/

      // creates the instructions for user to read
      var instructionScreenDiv = document.createElement('div');
      var instructionScreen = new InstructionScreen(instructionScreenDiv, map);
      instructionScreenDiv.index = 1;
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(instructionScreenDiv);

      // creates the next Button
      var nextButtonDiv = document.createElement('div');
      var nextButton = new NextButton(nextButtonDiv, map);
      nextButtonDiv.style.display = "none";
      nextButtonDiv.index = 1;
      map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(nextButtonDiv);

      // times it for 1 seconds before before next button appears
      var count = 0;
      setInterval(function(){ 
        count++;
        // next button appears
        if (count == 1) {
          fadeIn(nextButtonDiv);
        }
      }, 1000);

      // closes the instructions after next is pressed and loads selections
      google.maps.event.addDomListener(nextButtonDiv, 'click', function() {
        fadeOut(instructionScreenDiv);
        fadeOut(nextButtonDiv);
      });  
    }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    


  </head>
  <body>
    
    <div id="map_canvas"></div>
    <div id="arrow"></div>
    <div id="container">  
        <select id="yearSelect" onchange="hideIf2014IsChosen()">
          <option value="" disabled selected>Year</option>
          <option value='2014'> 2014 </option> 
          <option value='2015'> 2015 </option>
        </select>
        <button onclick="getMarkerFromChosenTime()" class="action-button shadow animate blue">Lets Go!</button> 
        <select id="monthSelect">
          <option value="" disabled selected>Month</option>
          <option value="01" class="hideIf2014">January</option>
            <option value="02" class="hideIf2014">February</option>
            <option value="03" class="hideIf2014">March</option>
            <option value="04" class="hideIf2014">April</option>
            <option value="05" class="hideIf2014">May</option>
            <option value="06" class="hideIf2014">June</option>
            <option value="07" class="hideIf2014">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12" class="hideIf2014">December</option>
        </select>
    </div>
    <script>
    /**
     * [Checks to see if 2014 is chosen, if it is then take out all the monthes before August as its not available]
     */
      function hideIf2014IsChosen() {
        var checkIf2014IsChosen = getYear();
        var arrayOfMonthesBeforeAugust2014 = document.getElementsByClassName("hideIf2014");
        if (checkIf2014IsChosen === '2014') {
          // just to not annoy the user with way too many alerts
          if (numOfAlertsAbout2014 === 0) {
          alert("Hackalist API doesn't have hackathons listed before August 2014, so they've been removed");
          }
          // removes those options from selection
          for (var i = 0; i < arrayOfMonthesBeforeAugust2014.length; i++) {
            arrayOfMonthesBeforeAugust2014[i].style.display = "none";
          }
          numOfAlertsAbout2014++;
        } else {
          // ensures for 2015 that they can choose monthes before August
          for (var i = 0; i < arrayOfMonthesBeforeAugust2014.length; i++) {
            arrayOfMonthesBeforeAugust2014[i].style.display = "inline-block";
          }
        } 
      }
    </script>
    <p> Send any bugs you notice to github.com/mding5692/mapathon as an issue please </p>
 </body>
</html>
