<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Mapathon - Mapping upcoming and past hackathons by month</title>
    <!-- Google Maps API -->
  
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
      <link href='http://fonts.googleapis.com/css?family=Pacifico' rel='stylesheet' type='text/css'>
    <link href="./css/style.css" rel="stylesheet">    
    <script>

    /*
    Format of Hackalist API
{
  "August": [
    {
      "title": "GeauxHack",
      "url": "http://geauxhack.com/",
      "startDate": "August 30",
      "endDate": "August 31",
      "year": "2014",
      "city": "Baton Rouge, LA, United States",
      "host": "Louisiana State University",
      "length": "24",
      "size": "150+",
      "travel": "unknown",
      "prize": "yes",
      "highSchoolers": "yes",
      "facebookURL": "https://www.facebook.com/GeauxHack",
      "twitterURL": "https://twitter.com/GeauxHack",
      "googlePlusURL": "",
      "notes": ""
    }
  ]
}

     */
    
    /*** Global variables ***/
    var map; // To reference the map
    var markerIcon = "https://cloud.githubusercontent.com/assets/9067177/8510467/e281c302-22b3-11e5-8ea4-08b55c12845a.png"; // The standard icon for the marker
   
    /*** Functions ***/
    
                    /******* UI and Animation functions *******/

    /**
     * Pops out opening screen with instructions on how to use it
     * Takes in the div to be used to store openingScreen and the map its for
     **/ 
    function InstructionScreen(openScreenDiv,map) {
      // creates a div HTML element to hold the UI
      var openScreenUI = document.createElement("div");
      openScreenUI.style.backgroundColor = '#ea6153';
      openScreenUI.style.border = '2px solid #333';
      openScreenUI.style.borderRadius = '10px';
      openScreenUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      openScreenUI.style.marginBottom = '10em';
      openScreenUI.style.textAlign = 'center';
      openScreenDiv.appendChild(openScreenUI);

      // creates another div inside to hold text
      var openingScreenText = document.createElement('div');
      openingScreenText.style.color = '#fff';
      openingScreenText.style.fontSize = '16px';
      openingScreenText.style.lineHeight = '38px';
      openingScreenText.style.paddingLeft = '10em';
      openingScreenText.style.paddingRight = '10em';
      openingScreenText.innerHTML = " <b> Instructions : </b> Choose the year and the month and get a display of the hackathons around the world at that time, press <b> next </b> to close the instructions ";
      openScreenUI.appendChild(openingScreenText);

    }

    /**
     * Loads the next button
     * If pressed it calls the closeOpeningScreen()
     **/
    function NextButton(openScreenDiv, map) {
      // creates a div HTML element to hold the UI
      var nextButton = document.createElement("div");
      nextButton.style.cursor = 'pointer';
      nextButton.style.backgroundColor = '#ea6153';
      nextButton.style.border = '2px solid #333';
      nextButton.style.borderRadius = '10px';
      nextButton.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      nextButton.style.marginBottom = '10em';
      nextButton.style.textAlign = 'center';
      openScreenDiv.appendChild(nextButton);

      // creates another div inside to hold text
      var nextButtonText = document.createElement('div');
      nextButtonText.style.color = '#fff';
      nextButtonText.style.fontFamily = 'Roboto,Arial,sans-serif';
      nextButtonText.style.fontSize = '20px';
      nextButtonText.style.lineHeight = '38px';
      nextButtonText.style.paddingLeft = '10em';
      nextButtonText.style.paddingRight = '10em';
      nextButtonText.innerHTML = " <b>NEXT </b> ";
      nextButton.appendChild(nextButtonText);
    }
        
    /**
     * For fading in animation on the buttons
     **/
    function fadeIn(element) {
      var op = 0.1;  // initial opacity
      element.style.display = 'block';
      var timer = setInterval(function () {
        if (op >= 1){
            clearInterval(timer);
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op += op * 0.05;
    }, 10);
  }

    /**
     * For fading out animation on the buttons
     **/
    function fadeOut(element) {
      var op = 1;  // initial opacity
      var timer = setInterval(function () {
          if (op <= 0.1){
              clearInterval(timer);
              element.style.display = 'none';
          }
          element.style.opacity = op;
          element.style.filter = 'alpha(opacity=' + op * 100 + ")";
          op -= op * 0.1;
    }, 50);
  }
                        
                    /****** Data and Map functions ******/

    /**
     * Returns the year chosen by user with the select html element 
     **/
    function getYear() {
        var yearSelect = document.getElementById('yearSelect');
        var chosenYear = yearSelect.options[yearSelect.selectedIndex].value;      
        return chosenYear;
    }
        
    /**
     * Returns the year chosen by user with the select html element 
     **/
    function getMonth() {
        var monthSelect = document.getElementById('monthSelect');
        var chosenMonth = monthSelect.options[monthSelect.selectedIndex].value;      
        return chosenMonth;
    }
        
    /**
     * Gets the year and month chosen and outputs marker on the map
     * Creates an error if there is no year or month
     **/
    function getMarkerFromChosenTime() {
        var url = "";
        var chosenYear = getYear();
        var chosenMonth = getMonth();
        if (chosenYear && chosenMonth) {
             url = createURLWhenTimeIsSpecifiedForHackalistAPI(chosenYear,chosenMonth);
             var JSONAboutHackathon = grabJSONFromHackalist(url);
             convertAddressesToMarker(JSONAboutHackathon);
        } else {
            alert("Year and Month hasn't been selected properly, try again!");
        }
    }

    /**
     * Creates url depending on which month is pressed
     * Takes in the year and month specified
     * Returns the URL
     **/
    function createURLWhenTimeIsSpecifiedForHackalistAPI(year,month) {
      yearStr = year.toString();
      monthStr = month.toString();
      var URL = "http://www.hackalist.org/api/1.0/" + yearStr + "/" + monthStr + ".json";
      return URL;
    }
    
    /**
     * Gets the JSON data from Hackalist API
     * Returns as JSON
     **/
    function grabJSONFromHackalist(hackalistURL) {
      var JSONrequest = new XMLHttpRequest();
      JSONrequest.open("GET", hackalistURL, false);
      JSONrequest.send();
      JSONresponse = JSONrequest.responseText;
      var JSONToBeReturned = JSON.parse(JSONresponse);
      return JSONToBeReturned;
    }
    
    /**
     * Converts the Addresses into LatLng format with Geocoding
     * Takes JSON data as Input where address information is used
     * Puts a marker onto the map with the details of the hackathon
     **/
    function convertAddressesToMarker(JSONInput) {
      var newlatLngArray = [];
      var givenAddress = JSON.stringify(JSONInput.August[0].city);
      var geocoder = new google.maps.Geocoder();
      var latLngAddress;
      // grabs the data from Hackalist API and assigns them to variables
      var hackathonName = JSONInput.August[0].title;
      var hackathonHost = JSONInput.August[0].host;
      var hackathonURL = JSONInput.August[0].url;
      var startDate = JSONInput.August[0].startDate;
      var endDate = JSONInput.August[0].endDate;
      
      geocoder.geocode( { 'address': givenAddress}, function(results, status) {
        
        if (status == google.maps.GeocoderStatus.OK) {
          latLngAddress = results[0].geometry.location;
          // creates a new marker with the address gained by geocoding
          var marker = new google.maps.Marker({
              map: map,
              position: latLngAddress,
              icon: markerIcon,
              clickable: true
          });
          // infowindow is created and attached to the marker
          marker.info = new google.maps.InfoWindow({
            content: "<div class='infowindow'> <b> Name: </b> " + hackathonName + "<br> <b> Host </b>: " + hackathonHost + "<br> <b>Address: </b>" + givenAddress + "<br> <b> Website: </b><a href=" + hackathonURL + ">" + hackathonURL +"</a>" + "<br> <b> Starting date : </b>" + startDate + "<br> <b> Ending date : </b>" + endDate + "</div>"
          });

          google.maps.event.addListener(marker, 'click', function() {
            marker.info.open(map, marker);
          });
        };
      });
    }
    /**
     * Creates the map; see this as the main function
     **/
    function initialize() {
     // below is configurable content for the map
      var mapOptions = {
        zoom: 4,
        minZoom: 3,
        center: {lat: -34.397, lng: 150.644},
        styles: [{"featureType":"water","stylers":[{"color":"#0e171d"}]},{"featureType":"landscape","stylers":[{"color":"#1e303d"}]},{"featureType":"road","stylers":[{"color":"#1e303d"}]},{"featureType":"poi.park","stylers":[{"color":"#1e303d"}]},{"featureType":"transit","stylers":[{"color":"#182731"},{"visibility":"simplified"}]},{"featureType":"poi","elementType":"labels.icon","stylers":[{"color":"#f0c514"},{"visibility":"off"}]},{"featureType":"poi","elementType":"labels.text.stroke","stylers":[{"color":"#1e303d"},{"visibility":"off"}]},{"featureType":"transit","elementType":"labels.text.fill","stylers":[{"color":"#e77e24"},{"visibility":"off"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#94a5a6"}]},{"featureType":"administrative","elementType":"labels","stylers":[{"visibility":"simplified"},{"color":"#e84c3c"}]},{"featureType":"poi","stylers":[{"color":"#e84c3c"},{"visibility":"off"}]}],
        disableDefaultUI: true
      }; 
      map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
      
      /** Sets up the UI and instructions **/

      // creates the instructions for user to read
      var instructionScreenDiv = document.createElement('div');
      var instructionScreen = new InstructionScreen(instructionScreenDiv, map);
      instructionScreenDiv.index = 1;
      map.controls[google.maps.ControlPosition.LEFT_CENTER].push(instructionScreenDiv);

      // creates the next Button
      var nextButtonDiv = document.createElement('div');
      var nextButton = new NextButton(nextButtonDiv, map);
      nextButtonDiv.style.display = "none";
      nextButtonDiv.index = 1;
      map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(nextButtonDiv);

      // times it for 3 seconds before next Button appears
      var count = 0;
      setInterval(function(){ 
        count++;
        if (count == 2) {
          fadeIn(nextButtonDiv);
        }
      }, 1000);

      // closes the instructions after next is pressed and loads selections
      google.maps.event.addDomListener(nextButtonDiv, 'click', function() {
        fadeOut(instructionScreenDiv);
        fadeOut(nextButtonDiv);

      });  
    }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    


  </head>
  <body>
    
    <div id="map_canvas"></div>
    <div class="container">  
        <select id="yearSelect">
          <option value="" disabled selected>Year</option>
          <option value='2014'> 2014 </option> 
          <option value='2015'> 2015 </option>
        </select>
        <a href="#chosenTime" onclick="getMarkerFromChosenTime()" class="action-button shadow animate blue">Lets Go!</a> 
        <select id="monthSelect">
          <option value="" disabled selected>Month</option>
          <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
    </div>
 </body>
</html>
